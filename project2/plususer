#!/bin/bash

while getopts ":h" opt; do
   case "${opt}" in
      h)
	echo 'For creating a user, use this script, as ./plususer <username>. This will create a user and group with the following username, if no options are given, a default home directory and shell will be made. The default home directory is /home/<username> and default shell is /bin/bash.
The following options are:
	-s <shell>: Will create a shell for user.
	-d <home>: Will create a home directory for user.
	-g "<groups>": Will put users in given groups, put the groups in "" separated by a space, 
	e.g, -g "g1 g2 g3".
	-c "<comment>": Will add the users comment or description for the user.
	-h: Help page.'
	exit 0
	;;
      ?)
	echo "Please use -h: For help"
        exit 1
        ;;
    esac
done

if [[ $(id -u ) -ne 0 ]]; then
   echo "Run as Sudo User"
   exit 1
fi

user=$1
shell=/bin/bash
home=/home/$user
groups=""
comment=""

shift

while getopts ":s:d:g:c:h" opt; do
   case "${opt}" in
      s)
        shell=${OPTARG}
	;;
      d)
	home=${OPTARG}
	;;
      c)
	comment=${OPTARG}
	;;
      g)
        groups=${OPTARG}
	;;
      h)
        echo 'For creating a user, use this script, as ./plususer <username>. This will create a user and group with the following username, if no options are given, a default home directory and shell will be made. The default home directory is /home/<username> and default shell is /bin/bash.
The following options are:
	-s <shell>: Will create a shell for user.
	-d <home>: Will create a home directory for user.
	-g "<groups>": Will put users in given groups, put the groups in "" separated by a space, 
	e.g, -g "g1 g2 g3".
	-c "<comment>": Will add the users comment or description for the user.
	-h: Help page.'
	exit 0
	;;
      :)
        echo "Error: -${OPTARG} requires an argument"
        exit 1
        ;;
      ?)
        echo "Please use the options of -s: For the specified shell, -d: For the home directory of the user, -g: Additional groups that the user wants to be added to. -h: For help"
        exit 1
        ;;
    esac
done

user_match=$(cat /etc/passwd | grep -w $user)

if [[ ! -z $user_match ]]; then
  echo "Username is already taken, please choose a different name"
  exit 1
fi

uid=1001
gid=1001
cont=true

while $cont; do
  match=$(grep -w "^${uid}" /etc/passwd)
  if [[ -z $match && $uid -ne 65534 ]]; then
     cont=false
  else
     ((uid++))
  fi
done

cont=true

while $cont; do
  match=$(grep -w $gid /etc/group)
  if [[ -z $match && $gid -ne 65534 ]]; then
     cont=false
  else
     ((gid++))
  fi
done

cat >> /etc/passwd <<- EOF
$user:*:$uid:$uid:$comment:$home:$shell
EOF

cat >> /etc/group <<- EOF
$user:x:$gid:
EOF

mkdir $home

shopt -s dotglob
for file in /etc/skel/*; do
   base=$(basename $file)
   cp -r $file "${home}/${base}"
done
shopt -u dotglob

chown -R $user:$user $home
chmod -R go=u,go-w $home
chmod go= $home

if [[ ! -z $groups ]]; then
  for g in $groups; do
    column=$(grep -nw "^${g}" /etc/group)
    c_no=${column%%:*}
    if [[ ! -z $c_no ]]; then 
	    group_line=$(grep "^${g}:" /etc/group)
	if [[ "${group_line}" == *":" ]]; then
    	    sed -i.bak "${c_no}s/$/${user}/" /etc/group
    	else 
	    sed -i.bak "${c_no}s/$/,${user}/" /etc/group
	fi
	echo "User was added to group $g"
    else
	echo "Group $g was not found"
    fi
  done
fi

passwd $user
